<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  <title>Front → Gmail Migration</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app">
    <nav class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Front → Gmail Migration</div>
          <div class="subtitle">Safe, message‑ID only, status‑aware labeling</div>
        </div>
      </div>
      <div id="statusChip" class="chip idle"><dot></dot><span id="statusText">Idle</span></div>
    </nav>
    <main class="container">
      <div id="toasts" class="toasts"></div>
      <div class="grid">
        <section class="card">
          <header class="card-header">
            <div class="card-title">Secrets</div>
            <small class="helper">Stored securely in your system keychain</small>
          </header>
          <div class="card-body">
            <div class="stack">
              <div class="row" style="justify-content: space-between;">
                <div class="status-row">
                  <strong>Front API Token</strong>
                  <span id="statusFront" class="status-badge warn">Not configured</span>
                </div>
                <button id="btnFront" class="btn btn-secondary">Configure</button>
              </div>
              <div class="row" style="justify-content: space-between; align-items: flex-start;">
                <div class="status-row" style="gap: 8px;">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <div class="status-row">
                      <strong>Google Credentials</strong>
                      <span id="statusGoogle" class="status-badge warn">Not configured</span>
                    </div>
                    <div class="status-row">
                      <span class="helper">OAuth Token</span>
                      <span id="statusGoogleToken" class="status-badge warn">None</span>
                    </div>
                  </div>
                </div>
                <button id="btnGoogle" class="btn btn-secondary">Configure</button>
              </div>
            </div>
          </div>
        </section>
        <section class="card">
          <header class="card-header">
            <div class="card-title">Run</div>
            <small class="helper">Dry run recommended first</small>
          </header>
          <div class="card-body">
            <div class="stack">
              <div class="row">
                <button id="run" class="btn btn-primary">Run Migration</button>
                <button id="cancel" class="btn btn-danger" disabled>Stop</button>
                <label class="row" style="margin-left: 8px;">
                  <input id="dryRun" type="checkbox" checked />
                  <span class="helper">Dry Run</span>
                </label>
                <div class="row" style="margin-left: auto;">
                  <label class="helper">Log Level</label>
                  <select id="logLevel" class="select">
                    <option value="error">error</option>
                    <option value="warn">warn</option>
                    <option value="info" selected>info</option>
                    <option value="debug">debug</option>
                  </select>
                  <button id="clear" class="btn btn-secondary">Clear</button>
                </div>
              </div>
              <pre id="output" class="log"></pre>
            </div>
          </div>
        </section>
  <!-- Modals -->
  <div id="modalFront" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalFrontTitle">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="modalFrontTitle" class="modal-title">Set Front API Token</div>
        <button id="closeFront" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Front API Token</label>
          <input id="frontInput" class="input" type="password" placeholder="Front API Token" />
        </div>
      </div>
      <div class="modal-footer">
        <div style="margin-right:auto; display:flex; gap:8px;">
          <button id="deleteFront" class="btn btn-danger">Delete</button>
        </div>
        <button id="cancelFront" class="btn btn-secondary">Cancel</button>
        <button id="saveFront" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="modalGoogle" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalGoogleTitle">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="modalGoogleTitle" class="modal-title">Set Google OAuth credentials.json</div>
        <button id="closeGoogle" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Paste full JSON</label>
          <textarea id="googleInput" class="textarea" rows="8" placeholder='{"installed": { ... }}'></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div style="margin-right:auto; display:flex; gap:8px;">
          <button id="deleteGoogle" class="btn btn-danger">Delete Credentials</button>
          <button id="deleteGoogleToken" class="btn btn-danger">Delete OAuth Token</button>
        </div>
        <button id="cancelGoogle" class="btn btn-secondary">Cancel</button>
        <button id="saveGoogle" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    const runBtn = document.getElementById('run');
    const cancelBtn = document.getElementById('cancel');
    const output = document.getElementById('output');
    const statusChip = document.getElementById('statusChip');
    const statusText = document.getElementById('statusText');
    const clearBtn = document.getElementById('clear');
    const setStatus = (state, text) => { statusChip.className = 'chip ' + state; statusText.textContent = text; };
    clearBtn.addEventListener('click', () => { output.textContent = ''; });
    const toasts = document.getElementById('toasts');
    const showToast = (text, type = 'info', duration = 3200) => {
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = text;
      toasts.appendChild(el);
      const timer = setTimeout(() => {
        el.style.transition = 'opacity 200ms ease';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 220);
      }, duration);
      return () => { clearTimeout(timer); el.remove(); };
    };

    // Secrets status
    const statusFront = document.getElementById('statusFront');
    const statusGoogle = document.getElementById('statusGoogle');
    const statusGoogleToken = document.getElementById('statusGoogleToken');
    async function refreshSecretsStatus() {
      try {
        const s = await window.electronAPI.getSecretsStatus();
        if (s.front) { statusFront.className = 'status-badge ok'; statusFront.textContent = 'Configured'; } else { statusFront.className = 'status-badge warn'; statusFront.textContent = 'Not configured'; }
        if (s.google) { statusGoogle.className = 'status-badge ok'; statusGoogle.textContent = 'Configured'; } else { statusGoogle.className = 'status-badge warn'; statusGoogle.textContent = 'Not configured'; }
        // Token info
        try {
          const info = await window.electronAPI.getGoogleTokenInfo();
          if (info.exists) {
            statusGoogleToken.className = 'status-badge ok';
            const scopes = Array.isArray(info.scopes) ? info.scopes : [];
            // Shorten well-known scopes for readability
            const short = scopes.map(s => {
              if (s.endsWith('/gmail.readonly')) return 'gmail.readonly';
              if (s.endsWith('/gmail.modify')) return 'gmail.modify';
              if (s.endsWith('/gmail.labels')) return 'gmail.labels';
              return s.split('/').pop();
            });
            statusGoogleToken.textContent = short.length ? short.join(', ') : 'Present';
          } else {
            statusGoogleToken.className = 'status-badge warn';
            statusGoogleToken.textContent = 'None';
          }
        } catch {}
      } catch {}
    }
    refreshSecretsStatus();

    // Modal helpers
    const modalFront = document.getElementById('modalFront');
    const modalGoogle = document.getElementById('modalGoogle');
    const frontInput = document.getElementById('frontInput');
    const googleInput = document.getElementById('googleInput');
    const openModal = (el) => { el.classList.add('show'); };
    const closeModal = (el) => { el.classList.remove('show'); };

    // Open modals
    document.getElementById('btnFront').addEventListener('click', () => { frontInput.value = ''; openModal(modalFront); });
    document.getElementById('btnGoogle').addEventListener('click', () => { googleInput.value = ''; openModal(modalGoogle); });

    // Close buttons
    document.getElementById('closeFront').addEventListener('click', () => closeModal(modalFront));
    document.getElementById('cancelFront').addEventListener('click', () => closeModal(modalFront));
    document.getElementById('closeGoogle').addEventListener('click', () => closeModal(modalGoogle));
    document.getElementById('cancelGoogle').addEventListener('click', () => closeModal(modalGoogle));

    // Save actions
    document.getElementById('saveFront').addEventListener('click', async () => {
      const token = (frontInput.value || '').trim();
      if (!token) { showToast('Token cannot be empty', 'error'); return; }
      try {
        await window.electronAPI.saveSecrets(token, '');
        showToast('Front token saved', 'success');
        closeModal(modalFront);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to save token', 'error'); }
    });
    document.getElementById('deleteFront').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteFrontToken();
        showToast('Front token deleted', 'success');
        closeModal(modalFront);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to delete token', 'error'); }
    });
    document.getElementById('saveGoogle').addEventListener('click', async () => {
      const text = (googleInput.value || '').trim();
      if (!text) { showToast('Credentials JSON cannot be empty', 'error'); return; }
      try {
        const j = JSON.parse(text);
        if (!j?.installed?.client_id || !j?.installed?.client_secret || !j?.installed?.redirect_uris) {
          throw new Error('Invalid shape');
        }
      } catch {
        showToast('Invalid Google credentials JSON', 'error');
        return;
      }
      try {
        await window.electronAPI.saveSecrets('', text);
        showToast('Google credentials saved', 'success');
        closeModal(modalGoogle);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to save credentials', 'error'); }
    });
    document.getElementById('deleteGoogleToken').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteGoogleToken();
        showToast('Google OAuth token deleted', 'success');
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to delete token', 'error'); }
    });
    document.getElementById('deleteGoogle').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteGoogleCreds();
        showToast('Google credentials deleted', 'success');
        closeModal(modalGoogle);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to delete credentials', 'error'); }
    });

    const append = (txt) => {
      output.textContent += txt;
      output.scrollTop = output.scrollHeight;
    };

    runBtn.addEventListener('click', async () => {
      output.textContent = '';
      runBtn.blur();
      runBtn.disabled = true;
      cancelBtn.disabled = false;
      setStatus('running','Running');
      showToast('Migration started', 'info');
      try {
        // Prevent duplicate listeners across runs
        if (window.electronAPI?.clearMigrationListeners) {
          window.electronAPI.clearMigrationListeners();
        }
        window.electronAPI.onMigrationData(chunk => append(chunk));
        window.electronAPI.onMigrationEnd(({ code }) => {
          append('\n\n[Process exited with code ' + code + ']');
          runBtn.disabled = false;
          cancelBtn.disabled = true;
          const ok = code === 0;
          setStatus(ok ? 'success' : 'error', ok ? 'Completed' : 'Failed');
          showToast(ok ? 'Migration completed' : 'Migration failed', ok ? 'success' : 'error');
          // Update token indicator in case OAuth occurred
          refreshSecretsStatus();
        });
        window.electronAPI.onMigrationError(({ message }) => append('\n[Error] ' + message + '\n'));
        const opts = { dryRun: document.getElementById('dryRun').checked, logLevel: document.getElementById('logLevel').value, };
        await window.electronAPI.runMigration(opts);
      } catch (err) {
        append('\n[Failed] ' + (err?.message || err) + '\n');
        runBtn.disabled = false;
        cancelBtn.disabled = true;
        showToast('Migration failed to start', 'error');
      }
    });

    cancelBtn.addEventListener('click', async () => {
      cancelBtn.disabled = true;
      try { await window.electronAPI.cancelMigration(); } catch {}
      setStatus('idle','Cancelled');
      showToast('Migration cancelled', 'info');
    });
  </script>
</body>
</html>
