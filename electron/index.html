<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  <title>Front → Gmail Migration</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app">
    <nav class="nav">
      <div class="brand">
        <img class="logo" src="./logo.png" alt="App Logo" />
        <div>
          <div class="title">Front → Gmail Migration</div>
          <div class="subtitle">Safe, message‑ID only, status‑aware labeling</div>
        </div>
      </div>
      <div class="row" style="gap: 10px; align-items: center;">
        <div id="statusChip" class="chip idle"><dot></dot><span id="statusText">Idle</span></div>
        <button id="runStop" class="btn btn-primary run-btn">Run Migration</button>
      </div>
    </nav>
    <main class="container">
      <div id="toasts" class="toasts"></div>
      <div class="grid">
        <section class="card">
          <header class="card-header">
            <div class="card-title">Authentication</div>
            <small class="helper">
              Stored securely in your system keychain
              <span class="info-icon" data-tip="Auth data (Front token, Google credentials, Gmail OAuth token) is stored encrypted by your OS keychain and never leaves your computer. The app does not save email content; only a CSV report is written to ./reports.">i</span>
            </small>
          </header>
          <div class="card-body">
            <div class="stack">
              <div class="row" style="justify-content: space-between;">
                <div class="status-row">
                  <span class="helper">Front API Token</span>
                  <span id="statusFront" class="status-badge warn">Not configured</span>
                </div>
                <button id="btnFront" class="btn btn-secondary">Configure</button>
              </div>
              <div class="row" style="justify-content: space-between;">
                <div class="status-row">
                  <span class="helper">Google Credentials</span>
                  <span id="statusGoogle" class="status-badge warn">Not configured</span>
                </div>
                <button id="btnGoogle" class="btn btn-secondary">Configure</button>
              </div>
              <div class="row" style="justify-content: space-between;">
                <div class="status-row">
                  <span class="helper">Gmail OAuth Token</span>
                  <span id="statusGoogleToken" class="status-badge warn">None</span>
                </div>
                <button id="btnGoogleToken" class="btn btn-secondary">Configure</button>
              </div>
            </div>
          </div>
        </section>
        <section class="card">
          <header class="card-header">
            <div class="card-title">Run Settings</div>
            <small class="helper">Options apply to the next run</small>
          </header>
          <div class="card-body">
            <div class="stack">
              <div class="row" style="gap:8px; align-items:center; justify-content: space-between; width: 100%;">
                <div class="row" style="gap:6px; align-items:center;">
                  <span class="helper">Dry Run</span>
                  <span class="info-icon" data-tip="Simulate the migration without making changes to Gmail. Authenticates, fetches data, logs planned label changes, and writes a CSV report. Disable to perform the actual migration.">i</span>
                </div>
                <label id="dryRunToggle" class="toggle">
                  <input id="dryRun" type="checkbox" checked />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="row" style="gap:8px; align-items:center; justify-content: space-between; width: 100%;">
                <div class="row" style="gap:6px; align-items:center;">
                  <label class="helper" for="logLevel">Log Detail</label>
                  <span class="info-icon" data-tip="Controls log verbosity. Default shows key steps and results; Detailed adds per-item lookups and diagnostics. Does not affect behavior.">i</span>
                </div>
                <select id="logLevel" class="select" style="width: 140px;">
                  <option value="info" selected>Default</option>
                  <option value="debug">Detailed</option>
                </select>
              </div>
              <div class="row" style="gap:8px; align-items:center; justify-content: space-between; width: 100%;">
                <div class="row" style="gap:6px; align-items:center;">
                  <label class="helper" for="frontInbox">Front Inbox</label>
                  <span class="info-icon" data-tip="Limit the migration to a single Front inbox. Leave as All Inboxes to migrate across all inboxes your token can access.">i</span>
                </div>
                <div id="frontInboxControl" class="row" style="gap:8px; align-items:center; min-height: 40px;">
                  <select id="frontInbox" class="select" style="width: 240px; display: none;"></select>
                  <span id="frontInboxLoading" class="helper" style="display:none;"><span class="spinner" aria-hidden="true"></span>Loading…</span>
                  <span id="frontInboxNeedAuth" class="helper">Authenticate Front first</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card span-2">
          <header class="card-header">
            <div class="card-title">Logs</div>
          </header>
          <div class="card-body">
            <div class="log-panel">
              <pre id="output" class="log"></pre>
              <div class="log-actions">
                <button id="openReports" class="btn btn-secondary">Open Reports</button>
                <button id="clear" class="btn btn-secondary">Clear</button>
              </div>
            </div>
          </div>
        </section>
  <!-- Modals -->
  <div id="modalFront" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalFrontTitle">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="modalFrontTitle" class="modal-title">Set Front API Token</div>
        <button id="closeFront" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="row" style="gap:6px; align-items:center;">
            <label>Front API Token</label>
            <span class="info-icon" data-tip="In Front: Settings → Developers → API tokens → Create a token with read access. Paste the token value here.">i</span>
          </div>
          <input id="frontInput" class="input" type="password" placeholder="Front API Token" />
        </div>
        <div id="frontConfiguredMsg" class="helper" style="display:none; margin-top: 8px;">
          A Front API token is already saved. To change it, delete it first.
        </div>
      </div>
      <div class="modal-footer">
        <div style="margin-right:auto; display:flex; gap:8px;">
          <button id="deleteFront" class="btn btn-danger">Delete</button>
        </div>
        <button id="cancelFront" class="btn btn-secondary">Cancel</button>
        <button id="saveFront" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="modalGoogle" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalGoogleTitle">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="modalGoogleTitle" class="modal-title">Set Google OAuth credentials.json</div>
        <button id="closeGoogle" class="btn btn-secondary">×</button>
      </div>
          <div class="modal-body">
        <div class="field">
          <div class="row" style="gap:6px; align-items:center;">
            <label>Google credentials.json</label>
            <span id="gcTooltip" class="info-icon with-bubble" tabindex="0" role="img" aria-label="Help about Google credentials">
              i
              <div class="tip-bubble">
                <div>Enable Gmail API, then go to Credentials → Create credentials → OAuth client ID (Desktop app).</div>
                <div>Download <b>credentials.json</b> and <b>drag & drop</b> the file into the box below.</div>
                <div class="tip-url">https://console.cloud.google.com/apis/credentials</div>
              </div>
            </span>
          </div>
          <textarea id="googleInput" class="textarea dropzone" rows="8" placeholder='Drag & drop credentials.json here' readonly aria-readonly="true"></textarea>
        </div>
        <div id="googleConfiguredMsg" class="helper" style="display:none; margin-top: 8px;">
          Google OAuth credentials are already saved. To change them, delete first.
        </div>
      </div>
      <div class="modal-footer">
        <div style="margin-right:auto; display:flex; gap:8px;">
          <button id="deleteGoogle" class="btn btn-danger">Delete Credentials</button>
        </div>
        <button id="cancelGoogle" class="btn btn-secondary">Cancel</button>
        <button id="saveGoogle" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="modalGoogleToken" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalGoogleTokenTitle">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="modalGoogleTokenTitle" class="modal-title">Gmail OAuth Token</div>
        <button id="closeGoogleToken" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="row" style="gap:6px; align-items:center;">
            <label>Current Scopes</label>
            <span class="info-icon" data-tip="The app creates this token during the first run via a browser flow. Delete it here to re‑authenticate or to change Gmail scopes.">i</span>
          </div>
          <div id="tokenScopes" class="helper">None</div>
        </div>
      </div>
      <div class="modal-footer">
        <div style="margin-right:auto; display:flex; gap:8px;">
          <button id="deleteGoogleToken" class="btn btn-danger">Delete Gmail OAuth Token</button>
        </div>
        <button id="cancelGoogleToken" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <script>
    const runStopBtn = document.getElementById('runStop');
    const output = document.getElementById('output');
    const statusChip = document.getElementById('statusChip');
    const statusText = document.getElementById('statusText');
    const clearBtn = document.getElementById('clear');
    const openReportsBtn = document.getElementById('openReports');
    const frontInboxEl = document.getElementById('frontInbox');
    const frontInboxNeedAuth = document.getElementById('frontInboxNeedAuth');
    const frontInboxLoading = document.getElementById('frontInboxLoading');
    const dryRunEl = document.getElementById('dryRun');
    const dryRunToggle = document.getElementById('dryRunToggle');
    const logLevelEl = document.getElementById('logLevel');
    const setStatus = (state, text) => { statusChip.className = 'chip ' + state; statusText.textContent = text; };
    clearBtn.addEventListener('click', () => { output.textContent = ''; });
    openReportsBtn.addEventListener('click', async () => {
      try {
        const res = await window.electronAPI.openReports();
        if (!res?.ok) throw new Error(res?.error || 'Failed to open');
      } catch (e) {
        const msg = (e && e.message) ? e.message : 'Could not open reports folder';
        showToast(msg, 'error');
      }
    });
    const toasts = document.getElementById('toasts');
    const showToast = (text, type = 'info', duration = 3200) => {
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = text;
      toasts.appendChild(el);
      const timer = setTimeout(() => {
        el.style.transition = 'opacity 200ms ease';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 220);
      }, duration);
      return () => { clearTimeout(timer); el.remove(); };
    };

    // Secrets status
    const statusFront = document.getElementById('statusFront');
    const statusGoogle = document.getElementById('statusGoogle');
    const statusGoogleToken = document.getElementById('statusGoogleToken');
    const btnFront = document.getElementById('btnFront');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnGoogleToken = document.getElementById('btnGoogleToken');

    // Track secrets state for modal behavior
    const secrets = { front: false, google: false, oauthExists: false, oauthScopes: [] };
    async function refreshSecretsStatus() {
      try {
        const s = await window.electronAPI.getSecretsStatus();
        secrets.front = Boolean(s.front);
        secrets.google = Boolean(s.google);
        if (secrets.front) { statusFront.className = 'status-badge ok'; statusFront.textContent = 'Configured'; } else { statusFront.className = 'status-badge warn'; statusFront.textContent = 'Not configured'; }
        if (secrets.google) { statusGoogle.className = 'status-badge ok'; statusGoogle.textContent = 'Configured'; } else { statusGoogle.className = 'status-badge warn'; statusGoogle.textContent = 'Not configured'; }
        // Token info
        try {
          const info = await window.electronAPI.getGoogleTokenInfo();
          secrets.oauthExists = Boolean(info.exists);
          secrets.oauthScopes = Array.isArray(info.scopes) ? info.scopes : [];
          if (secrets.oauthExists) {
            statusGoogleToken.className = 'status-badge ok';
            // Shorten well-known scopes for readability
            const short = secrets.oauthScopes.map(s => {
              if (s.endsWith('/gmail.readonly')) return 'gmail.readonly';
              if (s.endsWith('/gmail.modify')) return 'gmail.modify';
              if (s.endsWith('/gmail.labels')) return 'gmail.labels';
              return s.split('/').pop();
            });
            statusGoogleToken.textContent = short.length ? short.join(', ') : 'Present';
          } else {
            statusGoogleToken.className = 'status-badge warn';
            statusGoogleToken.textContent = 'None';
          }
        } catch {}

        // Keep action buttons labeled as "Configure" regardless of state
        btnFront.textContent = 'Configure';
        btnGoogle.textContent = 'Configure';
        btnGoogleToken.textContent = 'Configure';
      } catch {}
      // Refresh inbox list if Front is configured
      try {
        if (secrets.front) { await loadFrontInboxes(); } else { resetFrontInboxSelect(); }
      } catch {}
    }
    refreshSecretsStatus();

    function resetFrontInboxSelect() {
      if (!frontInboxEl) return;
      // Hide the dropdown when Front isn't authed and show helper text
      frontInboxEl.style.display = 'none';
      if (frontInboxNeedAuth) frontInboxNeedAuth.style.display = '';
      if (frontInboxLoading) frontInboxLoading.style.display = 'none';
    }

    async function loadFrontInboxes() {
      if (!frontInboxEl) return;
      // Show the dropdown and hide the helper once we can load
      if (frontInboxNeedAuth) frontInboxNeedAuth.style.display = 'none';
      if (frontInboxLoading) frontInboxLoading.style.display = '';
      frontInboxEl.style.display = 'none';
      frontInboxEl.disabled = true;
      frontInboxEl.innerHTML = '';
      const baseOpt = document.createElement('option');
      baseOpt.value = '';
      baseOpt.textContent = 'All Inboxes';
      frontInboxEl.appendChild(baseOpt);
      try {
        const res = await window.electronAPI.listFrontInboxes();
        if (!res?.ok) throw new Error(res?.error || 'Failed to fetch inboxes');
        const list = Array.isArray(res.inboxes) ? res.inboxes : [];
        list.forEach(({ id, name }) => {
          const o = document.createElement('option');
          o.value = id;
          o.textContent = name;
          frontInboxEl.appendChild(o);
        });
        frontInboxEl.disabled = false;
        if (frontInboxLoading) frontInboxLoading.style.display = 'none';
        frontInboxEl.style.display = '';
      } catch (e) {
        // keep default and disabled, and toast error
        showToast('Could not load Front inboxes', 'error');
        if (frontInboxLoading) frontInboxLoading.style.display = 'none';
        if (frontInboxNeedAuth) {
          frontInboxNeedAuth.textContent = 'Failed to load inboxes';
          frontInboxNeedAuth.style.display = '';
        }
      }
    }

    // Modal helpers
    const modalFront = document.getElementById('modalFront');
    const modalGoogle = document.getElementById('modalGoogle');
    const modalGoogleToken = document.getElementById('modalGoogleToken');
    const frontInput = document.getElementById('frontInput');
    const googleInput = document.getElementById('googleInput');
    const openModal = (el) => { el.classList.add('show'); };
    const closeModal = (el) => { el.classList.remove('show'); };

    // Open modals (conditional modes)
    const frontField = document.querySelector('#modalFront .modal-body .field');
    const frontMsg = document.getElementById('frontConfiguredMsg');
    const saveFrontBtn = document.getElementById('saveFront');
    const deleteFrontBtn = document.getElementById('deleteFront');
    btnFront.addEventListener('click', () => {
      // Configure mode when missing; delete-only when present
      if (secrets.front) {
        // Delete-only mode
        frontInput.value = '';
        if (frontField) frontField.style.display = 'none';
        if (frontMsg) frontMsg.style.display = '';
        if (saveFrontBtn) saveFrontBtn.style.display = 'none';
        if (deleteFrontBtn) deleteFrontBtn.style.display = '';
      } else {
        // Create mode
        frontInput.value = '';
        if (frontField) frontField.style.display = '';
        if (frontMsg) frontMsg.style.display = 'none';
        if (saveFrontBtn) saveFrontBtn.style.display = '';
        if (deleteFrontBtn) deleteFrontBtn.style.display = 'none';
      }
      openModal(modalFront);
    });

    const googleField = document.querySelector('#modalGoogle .modal-body .field');
    const googleMsg = document.getElementById('googleConfiguredMsg');
    const saveGoogleBtn = document.getElementById('saveGoogle');
    const deleteGoogleBtn = document.getElementById('deleteGoogle');
    btnGoogle.addEventListener('click', () => {
      if (secrets.google) {
        // Delete-only mode
        googleInput.value = '';
        if (googleField) googleField.style.display = 'none';
        if (googleMsg) googleMsg.style.display = '';
        if (saveGoogleBtn) saveGoogleBtn.style.display = 'none';
        if (deleteGoogleBtn) deleteGoogleBtn.style.display = '';
      } else {
        // Create mode
        googleInput.value = '';
        if (googleField) googleField.style.display = '';
        if (googleMsg) googleMsg.style.display = 'none';
        if (saveGoogleBtn) saveGoogleBtn.style.display = '';
        if (deleteGoogleBtn) deleteGoogleBtn.style.display = 'none';
      }
      openModal(modalGoogle);
    });

    btnGoogleToken.addEventListener('click', () => {
      // Only show delete button if token exists
      const del = document.getElementById('deleteGoogleToken');
      if (del) del.style.display = secrets.oauthExists ? '' : 'none';
      // Update scopes text if we have them
      const scopesEl = document.getElementById('tokenScopes');
      if (scopesEl) {
        const short = (secrets.oauthScopes || []).map(s => s.split('/').pop());
        scopesEl.textContent = secrets.oauthExists ? (short.join(', ') || 'Present') : 'None';
      }
      openModal(modalGoogleToken);
    });

    // No click navigation; URL is shown in tooltip for reference
    const tipUrlEl = document.querySelector('#gcTooltip .tip-url');
    if (tipUrlEl) {
      const openCreds = async () => {
        try {
          const res = await window.electronAPI.openExternal('https://console.cloud.google.com/apis/credentials');
          if (!res?.ok) throw new Error(res?.error || 'Failed to open');
        } catch (e) {
          showToast('Could not open Google Cloud Console', 'error');
        }
      };
      tipUrlEl.addEventListener('click', (e) => { e.preventDefault(); openCreds(); });
      tipUrlEl.setAttribute('tabindex', '0');
      tipUrlEl.setAttribute('role', 'link');
      tipUrlEl.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openCreds(); } });
      tipUrlEl.setAttribute('aria-label', 'Open Google Cloud Console Credentials');
    }

    // Close buttons
    document.getElementById('closeFront').addEventListener('click', () => closeModal(modalFront));
    document.getElementById('cancelFront').addEventListener('click', () => closeModal(modalFront));
    document.getElementById('closeGoogle').addEventListener('click', () => closeModal(modalGoogle));
    document.getElementById('cancelGoogle').addEventListener('click', () => closeModal(modalGoogle));
    document.getElementById('closeGoogleToken').addEventListener('click', () => closeModal(modalGoogleToken));
    document.getElementById('cancelGoogleToken').addEventListener('click', () => closeModal(modalGoogleToken));

    // Save actions
    document.getElementById('saveFront').addEventListener('click', async () => {
      const token = (frontInput.value || '').trim();
      if (!token) { showToast('Token cannot be empty', 'error'); return; }
      try {
        await window.electronAPI.saveSecrets(token, '');
        showToast('Front token saved', 'success');
        closeModal(modalFront);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to save token', 'error'); }
    });
    document.getElementById('deleteFront').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteFrontToken();
        showToast('Front token deleted', 'success');
        // Switch modal into create mode and keep it open
        if (frontField) frontField.style.display = '';
        if (frontMsg) frontMsg.style.display = 'none';
        if (saveFrontBtn) saveFrontBtn.style.display = '';
        const deleteBtn = document.getElementById('deleteFront');
        if (deleteBtn) deleteBtn.style.display = 'none';
        if (frontInput) frontInput.focus();
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to delete token', 'error'); }
    });
    document.getElementById('saveGoogle').addEventListener('click', async () => {
      const text = (googleInput.value || '').trim();
      if (!text) { showToast('Credentials JSON cannot be empty', 'error'); return; }
      try {
        const j = JSON.parse(text);
        if (!j?.installed?.client_id || !j?.installed?.client_secret || !j?.installed?.redirect_uris) {
          throw new Error('Invalid shape');
        }
      } catch {
        showToast('Invalid Google credentials JSON', 'error');
        return;
      }
      try {
        await window.electronAPI.saveSecrets('', text);
        showToast('Google credentials saved', 'success');
        closeModal(modalGoogle);
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to save credentials', 'error'); }
    });

    // Drag & drop support for Google credentials textarea
    if (googleInput) {
      const onDragOver = (e) => { e.preventDefault(); e.stopPropagation(); googleInput.classList.add('dragover'); };
      const onDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); googleInput.classList.remove('dragover'); };
      const onDrop = async (e) => {
        e.preventDefault(); e.stopPropagation(); googleInput.classList.remove('dragover');
        const files = e.dataTransfer && e.dataTransfer.files;
        if (!files || !files.length) return;
        const file = files[0];
        try {
          // Prefer modern File.text(); fallback to FileReader if unavailable
          const readText = file.text ? file.text.bind(file) : null;
          const text = readText ? await readText() : await new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onerror = () => reject(fr.error);
            fr.onload = () => resolve(String(fr.result || ''));
            fr.readAsText(file);
          });
          googleInput.value = text;
          showToast('Loaded credentials from file', 'success');
        } catch (err) {
          showToast('Failed to read dropped file', 'error');
        }
      };
      // Prevent typing/paste; hint user
      googleInput.addEventListener('keydown', (e) => { e.preventDefault(); });
      googleInput.addEventListener('paste', (e) => { e.preventDefault(); showToast('Drag & drop the credentials.json file here', 'info'); });
      googleInput.addEventListener('dragover', onDragOver);
      googleInput.addEventListener('dragenter', onDragOver);
      googleInput.addEventListener('dragleave', onDragLeave);
      googleInput.addEventListener('drop', onDrop);
    }
    document.getElementById('deleteGoogleToken').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteGoogleToken();
        showToast('Google OAuth token deleted', 'success');
        refreshSecretsStatus();
        // Keep modal open; update view
        const del = document.getElementById('deleteGoogleToken');
        if (del) del.style.display = 'none';
        const scopesEl = document.getElementById('tokenScopes');
        if (scopesEl) scopesEl.textContent = 'None';
      } catch (e) { showToast('Failed to delete token', 'error'); }
    });
    document.getElementById('deleteGoogle').addEventListener('click', async () => {
      try {
        await window.electronAPI.deleteGoogleCreds();
        showToast('Google credentials deleted', 'success');
        // Switch modal into create mode and keep it open
        if (googleField) googleField.style.display = '';
        if (googleMsg) googleMsg.style.display = 'none';
        if (saveGoogleBtn) saveGoogleBtn.style.display = '';
        const deleteBtn = document.getElementById('deleteGoogle');
        if (deleteBtn) deleteBtn.style.display = 'none';
        if (googleInput) googleInput.focus();
        refreshSecretsStatus();
      } catch (e) { showToast('Failed to delete credentials', 'error'); }
    });

    const append = (txt) => {
      output.textContent += txt;
      output.scrollTop = output.scrollHeight;
    };

    let isRunning = false;
    const setRunning = (running) => {
      isRunning = running;
      if (running) {
        runStopBtn.textContent = 'Stop';
        runStopBtn.className = 'btn btn-danger run-btn';
        dryRunEl.disabled = true;
        dryRunToggle.classList.add('disabled');
        logLevelEl.disabled = true;
        clearBtn.disabled = true;
      } else {
        runStopBtn.textContent = 'Run Migration';
        runStopBtn.className = 'btn btn-primary run-btn';
        dryRunEl.disabled = false;
        dryRunToggle.classList.remove('disabled');
        logLevelEl.disabled = false;
        clearBtn.disabled = false;
      }
    };

    // No chip display in simplified UI; settings affect next run.

    runStopBtn.addEventListener('click', async () => {
      // If already running, confirm Stop
      if (isRunning) {
        const ok = window.confirm('Stop the current migration? This will cancel the run in progress.');
        if (!ok) return;
        try { await window.electronAPI.cancelMigration(); } catch {}
        setStatus('idle','Cancelled');
        showToast('Migration cancelled', 'info');
        setRunning(false);
        return;
      }

      // Start a new run
      output.textContent = '';
      runStopBtn.blur();
      setRunning(true);
      setStatus('running','Running');
      showToast('Migration started', 'info');
      try {
        // Prevent duplicate listeners across runs
        if (window.electronAPI?.clearMigrationListeners) {
          window.electronAPI.clearMigrationListeners();
        }
        window.electronAPI.onMigrationData(chunk => append(chunk));
        window.electronAPI.onMigrationEnd(({ code }) => {
          append('\n\n[Process exited with code ' + code + ']');
          const ok = code === 0;
          setStatus(ok ? 'success' : 'error', ok ? 'Completed' : 'Failed');
          showToast(ok ? 'Migration completed' : 'Migration failed', ok ? 'success' : 'error');
          // Update token indicator in case OAuth occurred
          refreshSecretsStatus();
          setRunning(false);
        });
        window.electronAPI.onMigrationError(({ message }) => append('\n[Error] ' + message + '\n'));
        const opts = {
          dryRun: document.getElementById('dryRun').checked,
          logLevel: document.getElementById('logLevel').value,
          frontInboxId: (frontInboxEl && !frontInboxEl.disabled) ? frontInboxEl.value : ''
        };
        await window.electronAPI.runMigration(opts);
      } catch (err) {
        append('\n[Failed] ' + (err?.message || err) + '\n');
        showToast('Migration failed to start', 'error');
        setRunning(false);
      }
    });
  </script>
</body>
</html>
