<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Front to Gmail Migration</title>
</head>
<body>
  <h1>Front to Gmail Migration</h1>
  <section>
    <h3>Secrets (first run)</h3>
    <label>
      Front API Token:
      <input id="frontToken" type="password" placeholder="Front API Token" style="width: 100%" />
    </label>
    <br />
    <label>
      Google OAuth credentials.json (paste full JSON):
      <textarea id="googleCreds" rows="6" style="width: 100%" placeholder='{"installed": { ... }}'></textarea>
    </label>
    <br />
    <button id="saveSecrets">Save Secrets</button>
    <span id="saveStatus"></span>
  </section>
  <hr />
  <section>
    <button id="run">Run Migration</button>
    <button id="cancel" disabled>Stop</button>
    <label style="margin-left: 12px;">
      <input id="dryRun" type="checkbox" checked /> Dry Run
    </label>
    <label style="margin-left: 12px;">
      Log Level:
      <select id="logLevel">
        <option value="error">error</option>
        <option value="warn">warn</option>
        <option value="info" selected>info</option>
        <option value="debug">debug</option>
      </select>
    </label>
  </section>
  <pre id="output" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 8px; height: 300px; overflow: auto;"></pre>
  <script>
    const runBtn = document.getElementById('run');
    const cancelBtn = document.getElementById('cancel');
    const saveBtn = document.getElementById('saveSecrets');
    const saveStatus = document.getElementById('saveStatus');
    const output = document.getElementById('output');
    const frontTokenEl = document.getElementById('frontToken');
    const googleCredsEl = document.getElementById('googleCreds');

    saveBtn.addEventListener('click', async () => {
      saveStatus.textContent = 'Saving...';
      try {
        await window.electronAPI.saveSecrets(frontTokenEl.value, googleCredsEl.value);
        saveStatus.textContent = 'Saved to keychain';
        frontTokenEl.value = '';
        googleCredsEl.value = '';
      } catch (e) {
        saveStatus.textContent = 'Save failed: ' + (e?.message || e);
      }
    });

    const append = (txt) => {
      output.textContent += txt;
      output.scrollTop = output.scrollHeight;
    };

    runBtn.addEventListener('click', async () => {
      output.textContent = '';
      runBtn.disabled = true;
      cancelBtn.disabled = false;
      try {
        window.electronAPI.onMigrationData(chunk => append(chunk));
        window.electronAPI.onMigrationEnd(({ code }) => {
          append('\n\n[Process exited with code ' + code + ']');
          runBtn.disabled = false;
          cancelBtn.disabled = true;
        });
        window.electronAPI.onMigrationError(({ message }) => append('\n[Error] ' + message + '\n'));
        const opts = { dryRun: document.getElementById('dryRun').checked, logLevel: document.getElementById('logLevel').value, };
        await window.electronAPI.runMigration(opts);
      } catch (err) {
        append('\n[Failed] ' + (err?.message || err) + '\n');
        runBtn.disabled = false;
        cancelBtn.disabled = true;
      }
    });

    cancelBtn.addEventListener('click', async () => {
      cancelBtn.disabled = true;
      try { await window.electronAPI.cancelMigration(); } catch {}
    });
  </script>
</body>
</html>
